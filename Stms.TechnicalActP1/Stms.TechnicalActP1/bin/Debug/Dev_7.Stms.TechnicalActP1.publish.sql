/*
Deployment script for AX_Test_Interface

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DB_SOURCE_NAME "AX_Test"
:setvar DB_TARGET_NAME "AX_Test_Interface"
:setvar PROJECT_SCHEMA_NAME "dev"
:setvar UTC_OFFSET "3"
:setvar DatabaseName "AX_Test_Interface"
:setvar DefaultFilePrefix "AX_Test_Interface"
:setvar DefaultDataPath "E:\MSSQL\Data\"
:setvar DefaultLogPath "E:\MSSQL\Data\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
 Pre-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be executed before the build script.	
 Use SQLCMD syntax to include a file in the pre-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the pre-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/
IF NOT EXISTS (SELECT 1 FROM sys.schemas WHERE name = N'$(PROJECT_SCHEMA_NAME)')
	EXEC ('CREATE SCHEMA $(PROJECT_SCHEMA_NAME)')
GO

DROP VIEW IF EXISTS [$(PROJECT_SCHEMA_NAME)].[V_PBI_10988_TECHNICAL_ACT_P1]
GO

DROP VIEW IF EXISTS [$(PROJECT_SCHEMA_NAME)].[V_PBI_10988_TECHNICAL_ACT_P1_ACTUAL_DATE]
GO

DROP VIEW IF EXISTS [$(PROJECT_SCHEMA_NAME)].[V_PBI_10988_TECHNICAL_ACT_P1_ASUT_DATE]
GO

CREATE VIEW [$(PROJECT_SCHEMA_NAME)].[V_PBI_10988_TECHNICAL_ACT_P1]
AS
	SELECT 1 AS col
GO

CREATE VIEW [$(PROJECT_SCHEMA_NAME)].[V_PBI_10988_TECHNICAL_ACT_P1_ACTUAL_DATE]
AS
	SELECT 1 AS col
GO

CREATE VIEW [$(PROJECT_SCHEMA_NAME)].[V_PBI_10988_TECHNICAL_ACT_P1_ASUT_DATE]
AS
	SELECT 1 AS col
GO

GO

-- =============================================
-- Author: Teploukhov ES 
-- Create date: 20.08.2021
-- Pbi: http://eka-devops/devops/Sinara/DAX/_workitems/edit/10988
-- Description: Сводный технический акт П-1 с пробегами
-- 23.11.2021 доработка http://eka-devops/devops/Sinara/DAX/_workitems/edit/11959
-- 10.01.2022 доработка http://eka-devops/devops/Sinara/DAX/_workitems/edit/11880
-- 02.10.2022 доработка http://eka-devops/devops/Sinara/DAX/_workitems/edit/12766
-- 03.10.2022 доработка http://eka-devops/devops/Sinara/DAX/_workitems/edit/13390
-- =============================================
ALTER VIEW [$(PROJECT_SCHEMA_NAME)].V_PBI_10988_TECHNICAL_ACT_P1
AS

	SELECT
		techActAsut.[Серия локомотива],
		techActAsut.[Номер Локомотива],
		techActAsut.[Кол-во секций],
		techActAsut.[Дата постановки локомотива в ремонт],
		techActAsut.[Время постановки локомотива в ремонт],
		techActAsut.[№ Акта приемки Локомотива в ремонт],
		techActAsut.[Вид ремонта],
		techActAsut.[Дата выхода локомотива из ремонта],
		techActAsut.[Время выхода локомотива из ремонта],
		techActAsut.[№ Акта приемки Локомотива из ремонта],
		techActAsut.[Кол-во нахождения в ремонте одной секции],
		techActAsut.[Кол-во нахождения всех секций в ремонте(суммарно)],
		techActAsut.[Депо приписки(Примечание)],
		techActAsut.[Пробег на момент постановки локомотива на СО от последнего аналогичного ремонта],
		techActAsut.[Код журнала прибытия],
		techActAsut.[Фильтр подразделения],
		techActAsut.[Фильтр даты],
		techActAsut.[Заказчик],
		techActAsut.[Исполнитель],
		techActAsut.[Сортировка даты и времени]
	FROM [$(PROJECT_SCHEMA_NAME)].V_PBI_10988_TECHNICAL_ACT_P1_ASUT_DATE AS techActAsut

	UNION ALL

	SELECT
		techActActual.[Серия локомотива],
		techActActual.[Номер Локомотива],
		techActActual.[Кол-во секций],
		techActActual.[Дата постановки локомотива в ремонт],
		techActActual.[Время постановки локомотива в ремонт],
		techActActual.[№ Акта приемки Локомотива в ремонт],
		techActActual.[Вид ремонта],
		techActActual.[Дата выхода локомотива из ремонта],
		techActActual.[Время выхода локомотива из ремонта],
		techActActual.[№ Акта приемки Локомотива из ремонта],
		techActActual.[Кол-во нахождения в ремонте одной секции],
		techActActual.[Кол-во нахождения всех секций в ремонте(суммарно)],
		techActActual.[Депо приписки(Примечание)],
		techActActual.[Пробег на момент постановки локомотива на СО от последнего аналогичного ремонта],
		techActActual.[Код журнала прибытия],
		techActActual.[Фильтр подразделения],
		techActActual.[Фильтр даты],
		techActActual.[Заказчик],
		techActActual.[Исполнитель],
		techActActual.[Сортировка даты и времени]
	FROM [$(PROJECT_SCHEMA_NAME)].V_PBI_10988_TECHNICAL_ACT_P1_ACTUAL_DATE AS techActActual
GO

GO
PRINT N'Update complete.';


GO
